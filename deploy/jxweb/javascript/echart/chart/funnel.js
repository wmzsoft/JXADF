define("echarts/chart/funnel",["require","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Polygon","../config","../util/ecData","../util/number","zrender/tool/util","zrender/tool/color","zrender/tool/area","../chart"],function(e){function t(e,t,n,l,r){i.call(this,e,t,n,l,r),this.refresh(l)}var i=e("./base"),n=e("zrender/shape/Text"),l=e("zrender/shape/Line"),r=e("zrender/shape/Polygon"),a=e("../config");a.funnel={zlevel:0,z:2,clickable:!0,legendHoverLink:!0,x:80,y:60,x2:80,y2:60,min:0,max:100,minSize:"0%",maxSize:"100%",sort:"descending",gap:0,funnelAlign:"center",itemStyle:{normal:{borderColor:"#fff",borderWidth:1,label:{show:!0,position:"outer"},labelLine:{show:!0,length:10,lineStyle:{width:1,type:"solid"}}},emphasis:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0},labelLine:{show:!0}}}};var s=e("../util/ecData"),o=e("../util/number"),h=e("zrender/tool/util"),d=e("zrender/tool/color"),c=e("zrender/tool/area");return t.prototype={type:a.CHART_TYPE_FUNNEL,_buildShape:function(){var e=this.series,t=this.component.legend;this._paramsMap={},this._selected={},this.selectedMap={};for(var i,n=0,l=e.length;l>n;n++)if(e[n].type===a.CHART_TYPE_FUNNEL){if(e[n]=this.reformOption(e[n]),this.legendHoverLink=e[n].legendHoverLink||this.legendHoverLink,i=e[n].name||"",this.selectedMap[i]=t?t.isSelected(i):!0,!this.selectedMap[i])continue;this._buildSingleFunnel(n),this.buildMark(n)}this.addShapeList()},_buildSingleFunnel:function(e){var t=this.component.legend,i=this.series[e],n=this._mapData(e),l=this._getLocation(e);this._paramsMap[e]={location:l,data:n};for(var r,a=0,s=[],h=0,d=n.length;d>h;h++)r=n[h].name,this.selectedMap[r]=t?t.isSelected(r):!0,this.selectedMap[r]&&!isNaN(n[h].value)&&(s.push(n[h]),a++);if(0!==a){for(var c,p,u,g,b=this._buildFunnelCase(e),m=i.funnelAlign,f=i.gap,y=a>1?(l.height-(a-1)*f)/a:l.height,L=l.y,v="descending"===i.sort?this._getItemWidth(e,s[0].value):o.parsePercent(i.minSize,l.width),x="descending"===i.sort?1:0,_=l.centerX,S=[],h=0,d=s.length;d>h;h++)if(r=s[h].name,this.selectedMap[r]&&!isNaN(s[h].value)){switch(c=d-2>=h?this._getItemWidth(e,s[h+x].value):"descending"===i.sort?o.parsePercent(i.minSize,l.width):o.parsePercent(i.maxSize,l.width),m){case"left":p=l.x;break;case"right":p=l.x+l.width-v;break;default:p=_-v/2}u=this._buildItem(e,s[h]._index,t?t.getColor(r):this.zr.getColor(s[h]._index),p,L,v,c,y,m),L+=y+f,g=u.style.pointList,S.unshift([g[0][0]-10,g[0][1]]),S.push([g[1][0]+10,g[1][1]]),0===h&&(0===v?(g=S.pop(),"center"==m&&(S[0][0]+=10),"right"==m&&(S[0][0]=g[0]),S[0][1]-="center"==m?10:15,1==d&&(g=u.style.pointList)):(S[S.length-1][1]-=5,S[0][1]-=5)),v=c}b&&(S.unshift([g[3][0]-10,g[3][1]]),S.push([g[2][0]+10,g[2][1]]),0===v?(g=S.pop(),"center"==m&&(S[0][0]+=10),"right"==m&&(S[0][0]=g[0]),S[0][1]+="center"==m?10:15):(S[S.length-1][1]+=5,S[0][1]+=5),b.style.pointList=S)}},_buildFunnelCase:function(e){var t=this.series[e];if(this.deepQuery([t,this.option],"calculable")){var i=this._paramsMap[e].location,n=10,l={hoverable:!1,style:{pointListd:[[i.x-n,i.y-n],[i.x+i.width+n,i.y-n],[i.x+i.width+n,i.y+i.height+n],[i.x-n,i.y+i.height+n]],brushType:"stroke",lineWidth:1,strokeColor:t.calculableHolderColor||this.ecTheme.calculableHolderColor||a.calculableHolderColor}};return s.pack(l,t,e,void 0,-1),this.setCalculable(l),l=new r(l),this.shapeList.push(l),l}},_getLocation:function(e){var t=this.series[e],i=this.zr.getWidth(),n=this.zr.getHeight(),l=this.parsePercent(t.x,i),r=this.parsePercent(t.y,n),a=null==t.width?i-l-this.parsePercent(t.x2,i):this.parsePercent(t.width,i);return{x:l,y:r,width:a,height:null==t.height?n-r-this.parsePercent(t.y2,n):this.parsePercent(t.height,n),centerX:l+a/2}},_mapData:function(e){function t(e,t){return"-"===e.value?1:"-"===t.value?-1:t.value-e.value}function i(e,i){return-t(e,i)}for(var n=this.series[e],l=h.clone(n.data),r=0,a=l.length;a>r;r++)l[r]._index=r;return"none"!=n.sort&&l.sort("descending"===n.sort?t:i),l},_buildItem:function(e,t,i,n,l,r,a,o,h){var d=this.series,c=d[e],p=c.data[t],u=this.getPolygon(e,t,i,n,l,r,a,o,h);s.pack(u,d[e],e,d[e].data[t],t,d[e].data[t].name),this.shapeList.push(u);var g=this.getLabel(e,t,i,n,l,r,a,o,h);s.pack(g,d[e],e,d[e].data[t],t,d[e].data[t].name),this.shapeList.push(g),this._needLabel(c,p,!1)||(g.invisible=!0);var b=this.getLabelLine(e,t,i,n,l,r,a,o,h);this.shapeList.push(b),this._needLabelLine(c,p,!1)||(b.invisible=!0);var m=[],f=[];return this._needLabelLine(c,p,!0)&&(m.push(b.id),f.push(b.id)),this._needLabel(c,p,!0)&&(m.push(g.id),f.push(u.id)),u.hoverConnect=m,g.hoverConnect=f,u},_getItemWidth:function(e,t){var i=this.series[e],n=this._paramsMap[e].location,l=i.min,r=i.max,a=o.parsePercent(i.minSize,n.width),s=o.parsePercent(i.maxSize,n.width);return(t-l)*(s-a)/(r-l)+a},getPolygon:function(e,t,i,n,l,a,s,o,h){var c,p=this.series[e],u=p.data[t],g=[u,p],b=this.deepMerge(g,"itemStyle.normal")||{},m=this.deepMerge(g,"itemStyle.emphasis")||{},f=this.getItemStyleColor(b.color,e,t,u)||i,y=this.getItemStyleColor(m.color,e,t,u)||("string"==typeof f?d.lift(f,-.2):f);switch(h){case"left":c=n;break;case"right":c=n+(a-s);break;default:c=n+(a-s)/2}var L={zlevel:p.zlevel,z:p.z,clickable:this.deepQuery(g,"clickable"),style:{pointList:[[n,l],[n+a,l],[c+s,l+o],[c,l+o]],brushType:"both",color:f,lineWidth:b.borderWidth,strokeColor:b.borderColor},highlightStyle:{color:y,lineWidth:m.borderWidth,strokeColor:m.borderColor}};return this.deepQuery([u,p,this.option],"calculable")&&(this.setCalculable(L),L.draggable=!0),new r(L)},getLabel:function(e,t,i,l,r,a,s,o,p){var u,g=this.series[e],b=g.data[t],m=this._paramsMap[e].location,f=h.merge(h.clone(b.itemStyle)||{},g.itemStyle),y="normal",L=f[y].label,v=L.textStyle||{},x=f[y].labelLine.length,_=this.getLabelText(e,t,y),S=this.getFont(v),z=i;L.position=L.position||f.normal.label.position,"inner"===L.position||"inside"===L.position||"center"===L.position?(u=p,z=Math.max(a,s)/2>c.getTextWidth(_,S)?"#fff":d.reverse(i)):u="left"===L.position?"right":"left";var w={zlevel:g.zlevel,z:g.z+1,style:{x:this._getLabelPoint(L.position,l,m,a,s,x,p),y:r+o/2,color:v.color||z,text:_,textAlign:v.align||u,textBaseline:v.baseline||"middle",textFont:S}};return y="emphasis",L=f[y].label||L,v=L.textStyle||v,x=f[y].labelLine.length||x,L.position=L.position||f.normal.label.position,_=this.getLabelText(e,t,y),S=this.getFont(v),z=i,"inner"===L.position||"inside"===L.position||"center"===L.position?(u=p,z=Math.max(a,s)/2>c.getTextWidth(_,S)?"#fff":d.reverse(i)):u="left"===L.position?"right":"left",w.highlightStyle={x:this._getLabelPoint(L.position,l,m,a,s,x,p),color:v.color||z,text:_,textAlign:v.align||u,textFont:S,brushType:"fill"},new n(w)},getLabelText:function(e,t,i){var n=this.series,l=n[e],r=l.data[t],a=this.deepQuery([r,l],"itemStyle."+i+".label.formatter");return a?"function"==typeof a?a.call(this.myChart,{seriesIndex:e,seriesName:l.name||"",series:l,dataIndex:t,data:r,name:r.name,value:r.value}):"string"==typeof a?a=a.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}").replace("{a0}",l.name).replace("{b0}",r.name).replace("{c0}",r.value):void 0:r.name},getLabelLine:function(e,t,i,n,r,a,s,o,d){var c=this.series[e],p=c.data[t],u=this._paramsMap[e].location,g=h.merge(h.clone(p.itemStyle)||{},c.itemStyle),b="normal",m=g[b].labelLine,f=g[b].labelLine.length,y=m.lineStyle||{},L=g[b].label;L.position=L.position||g.normal.label.position;var v={zlevel:c.zlevel,z:c.z+1,hoverable:!1,style:{xStart:this._getLabelLineStartPoint(n,u,a,s,d),yStart:r+o/2,xEnd:this._getLabelPoint(L.position,n,u,a,s,f,d),yEnd:r+o/2,strokeColor:y.color||i,lineType:y.type,lineWidth:y.width}};return b="emphasis",m=g[b].labelLine||m,f=g[b].labelLine.length||f,y=m.lineStyle||y,L=g[b].label||L,L.position=L.position,v.highlightStyle={xEnd:this._getLabelPoint(L.position,n,u,a,s,f,d),strokeColor:y.color||i,lineType:y.type,lineWidth:y.width},new l(v)},_getLabelPoint:function(e,t,i,n,l,r,a){switch(e="inner"===e||"inside"===e?"center":e){case"center":return"center"==a?t+n/2:"left"==a?t+10:t+n-10;case"left":return"auto"===r?i.x-10:"center"==a?i.centerX-Math.max(n,l)/2-r:"right"==a?t-(l>n?l-n:0)-r:i.x-r;default:return"auto"===r?i.x+i.width+10:"center"==a?i.centerX+Math.max(n,l)/2+r:"right"==a?i.x+i.width+r:t+Math.max(n,l)+r}},_getLabelLineStartPoint:function(e,t,i,n,l){return"center"==l?t.centerX:n>i?e+Math.min(i,n)/2:e+Math.max(i,n)/2},_needLabel:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".label.show")},_needLabelLine:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".labelLine.show")},refresh:function(e){e&&(this.option=e,this.series=e.series),this.backupShapeList(),this._buildShape()}},h.inherits(t,i),e("../chart").define("funnel",t),t});